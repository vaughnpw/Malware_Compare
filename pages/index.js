import Layout from "../components/layout";
import "../style.less";

import { Component } from "react";
import ReactDOM from "react-dom";
import { Upload, Icon, message, Button } from 'antd';

import Router from 'next/router'; 
import fetch from 'isomorphic-unfetch'; 

const Dragger = Upload.Dragger;

const props = {
  name: 'file',
  multiple: true,
  accept: '.doc,.docx,.ppt,.pptx,.pdf,.png,.jpg,.txt',
  directory: false,
  action: '//jsonplaceholder.typicode.com/posts/'
};

class Index extends Component {

  constructor(props) {
    super(props);
    this.state = {
      data: ""
    };
  }

  

  handleUploadFile = (event) => {
    const status = event.file.status;
    if (status !== 'uploading') {
      console.log('file uploading: ', event.file);
      console.log('current file list: ', event.fileList);
    }
    if (status === 'done') {
      message.success(`${event.file.name} file uploaded successfully.`);
      console.log(`${event.file.name} file uploaded successfully.`);
      const data = new FormData();
      data.append('file', event.file);
      console.log('current data: ', data);
      this.setState({
        data
      });
      console.log('current state data: ', this.state.data);
    } else if (status === 'error') {
      message.error(`${event.file.name} file upload failed.`);
      console.log(`${event.file.name} file upload failed.`);
    }
  }

  handleSubmitFiles = (event)  => {
    const data = this.state.data;
    console.log('data when submitted: ', data);
    sessionStorage.setItem('data', JSON.stringify(data));
    data.append('apikey', '48b2abe33cca0ec3dbc468d90f0c2c1cf2441eed15f8c5c4de223deda5b2d10a');
    const postScan = new Promise((resolve, reject) => {
      resolve(fetch( 'https://www.virustotal.com/vtapi/v2/file/scan',
        {
          method: 'POST',
          headers: {
            'Content-Type': 'multipart/form-data',
            'Access-Control-Allow-Origin': '*'
          },
          formData: data
        }
      ));
    });
    postScan
    .then((res) => {
      console.log('res from postScan: ', res);
      const scanned = res.json();
      console.log('returned scan api call: ', scanned);
      Router.push({ 
        pathname: '/compare', 
        query: { 
          data: this.state.data
        }, 
      }); 
    })
    .catch((err) => {
      console.log('err: ', err);
    });
  }

  render() {
    return (
      <Layout>
        <div>
          <h2>Welcome to Malware Compare!</h2>
          <p>Here you can upload malware infected files and links to compare the malware 
            infections between them. You can also just upload one malware file and we will 
            render you a report breaking down the components of that malware package. Upload 
            your files below or insert your links in the menu to the left.</p>
        </div>
        <div className="bulk_file_selector">
          <Dragger {...props} onChange={this.handleUploadFile}>
            <p className="drag_upload_icon">
              <Icon type="inbox"/>
            </p>
            <span className="drag_upload_text">
              <p className="drag_upload_hint_1">Click or drag file to this area to upload</p>
              <p className="drag_upload_hint_2">Support for a single or bulk upload. Strictly 
              prohibit from uploading company data or other band files</p>
            </span>
          </Dragger>
        </div>
        <div className="file_submit_button">
          <Button type="primary" size="large" onClick={this.handleSubmitFiles}>
            Submit
          </Button>
        </div>
        <style jsx>{`
          .bulk_file_selector {
            height: 300px;
          }
          .drag_upload_icon {
            color: #1890ff;
            font-size: 42px;
          }
          .drag_upload_text {
            font-size: 18px;
          }
          .file_submit_button {
            padding: 24px;
            float: right;
          }
        `}</style>
      </Layout>
    );
  }
}

export default Index