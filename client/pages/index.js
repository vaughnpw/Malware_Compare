import Layout from "../components/layout";
import "../style.less";

import { Component } from "react";
import ReactDOM from "react-dom";
import { Upload, Icon, message, Button } from 'antd';

import Router from 'next/router'; 
import fetch from 'isomorphic-unfetch'; 

const Dragger = Upload.Dragger;

const props = {
  name: 'file',
  multiple: false,
  accept: '.doc,.docx,.ppt,.pptx,.pdf,.png,.jpg,.txt',
  directory: false,
  method: 'POST',
  action: '/upload'
};

class Index extends Component {

  constructor(props) {
    super(props);
    this.state = {
      resources: []
    };
  }

  handleUploadFile = async (event) => {
    const status = event.file.status;
    if (status !== 'uploading') {
      console.log('file uploading: ', event.file);
      console.log('current file list: ', event.fileList);
    }
    if (status === 'done') {
      message.success(`${event.file.name} file uploaded successfully.`);
      console.log(`${event.file.name} file uploaded successfully.`);
      const body = {
        file: {
          name: event.file.name,
          type: event.file.type
        }
      };
      try {  
        const res = await fetch('https://ms4axfydt9.execute-api.us-east-1.amazonaws.com/dev/submitFile',
          {
            method: 'POST',
            headers: {
              'Access-Control-Allow-Origin': '*',
				      'Access-Control-Allow-Credentials': true,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
          }
        );
        const json = await res.json();
        console.log('json returned from fetch: ', json);
        console.log('resource id from json: ', json.resource);
        console.log('old state resources: ', this.state.resources);
        const resources = this.state.resources;
        resources.push(json.resource);
        console.log('new state resources: ', resources);
        this.setState({
          resources: resources
        });
        console.log('updated state resources: ', this.state.resources);
        message.success(`${event.file.name} file scanned successfully.`);
      } catch(e) {
        message.error(`${event.file.name} file scan failed.`);
        console.log('error message: ', e);
        console.log(`${event.file.name} file scan failed.`);
      }
    } else if (status === 'error') {
      message.error(`${event.file.name} file upload failed.`);
      console.log(`${event.file.name} file upload failed.`);
    }
  }

  handleSubmitFiles = (event)  => {
    const resources = this.state.resources;
    console.log('resources when submitted: ', resources);
    Router.push({ 
      pathname: '/compare', 
      query: { 
        resources: JSON.stringify(resources)
      }, 
    });
  }

  render() {
    return (
      <Layout>
        <div>
          <h2>Welcome to Malware Compare!</h2>
          <p>Here you can upload malware infected files and links to compare the malware 
            infections between them. You can also just upload one malware file and we will 
            render you a report breaking down the components of that malware package. Upload 
            your files below or insert your links in the menu to the left.</p>
        </div>
        <div className="bulk_file_selector">
          <Dragger {...props} onChange={this.handleUploadFile}>
            <p className="drag_upload_icon">
              <Icon type="inbox"/>
            </p>
            <span className="drag_upload_text">
              <p className="drag_upload_hint_1">Click or drag file to this area to upload</p>
              <p className="drag_upload_hint_2">Support for a single or bulk upload. Strictly 
              prohibit from uploading company data or other band files</p>
              <p>Allowed File Types: .doc, .docx, .ppt, .pptx, .pdf, .png, .jpg, .txt</p>
            </span>
          </Dragger>
        </div>
        <div className="file_submit_button">
          <Button type="primary" size="large" onClick={this.handleSubmitFiles}>
            Submit
          </Button>
        </div>
        <style jsx>{`
          .bulk_file_selector {
            height: 300px;
          }
          .drag_upload_icon {
            color: #1890ff;
            font-size: 42px;
          }
          .drag_upload_text {
            font-size: 18px;
          }
          .file_submit_button {
            padding: 24px;
            float: right;
          }
        `}</style>
      </Layout>
    );
  }
}

export default Index