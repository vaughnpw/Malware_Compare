const request = require("request");
const fs = require('fs');
const AWS = require('aws-sdk');
const s3 = new AWS.S3({apiVersion: '2006-03-01'});

exports.start = (event, callback) => {
    console.log("BODY: ", event);
    
    scanFile(event)
        .then((body) => {
            callback(body);
        })
        .catch((err) => {
            callback(err);
        });
}

function scanFile(event) {
    return new Promise((resolve, reject) => {

        var params = {
            Bucket: 'com.malware.compare',
            Key: `files/${event.file.name}`
        };

        var formData = {
            apikey: '48b2abe33cca0ec3dbc468d90f0c2c1cf2441eed15f8c5c4de223deda5b2d10a',
            file: {
                value:  s3.getObject(params).createReadStream(),
                options: {
                  filename: event.file.name,
                  contentType: event.file.type
                }
            }
        };

        var options = {
            url: 'https://www.virustotal.com/vtapi/v2/file/scan',
            formData: formData
        };
    
        request.post(options, (err, response, body) => {
                if(err) {
                    console.log("SEND_MESSAGE_FAILURE: ", err);
                    reject(`SEND_MESSAGE_FAILURE: ${err}`);
                }
                else {
                    console.log("SEND_MESSAGE_SUCCESS: ", body);
                    resolve(body);
                }
            }
        );

    });
}