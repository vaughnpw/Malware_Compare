const request = require("request");
const AWS = require('aws-sdk');
const s3 = new AWS.S3({apiVersion: '2006-03-01'});

exports.start = (event, callback) => {
    console.log("BODY: ", event);
    
    const resources = JSON.parse(event.resources);

    var fn = function getReport(resource) {
        return new Promise((resolve, reject) => {
            var options = {
                method: "GET",
                url: `https://www.virustotal.com/vtapi/v2/file/report`,
                qs: {
                    resource: resource,
                    apikey: '48b2abe33cca0ec3dbc468d90f0c2c1cf2441eed15f8c5c4de223deda5b2d10a'
                }
            };
        
            request(options, (err, response, body) => {
                    if(err) {
                        console.log("SEND_MESSAGE_FAILURE: ", err);
                        reject(`SEND_MESSAGE_FAILURE: ${err}`);
                    }
                    else {
                        console.log("SEND_MESSAGE_SUCCESS: ", body);
                        
                        s3.putObject(
                            {
                                Bucket: 'com.malware.compare',
                                Key: `${resource}.json`,
                                Body: body.toString()
                            }, (err, putFile) => {
                                if(err) {
                                    console.log('put object failure: ', err);
                                    reject(err);
                                }
                                else {
                                    console.log('put object success: ', putFile);
                                    resolve(body)
                                }
                            }
                        );

                    }
                }
            );
        });
    };

    var actions = resources.map(fn);

    Promise.all(actions)
        .then((reports) => {
            console.log('array of reports: ', reports);
            const report = {
                reports: reports  
            };
            console.log('report object: ', report);
            callback(report);
        })
        .catch((err) => {
            console.log('promise err: ', err);
            callback(err);
        });

}